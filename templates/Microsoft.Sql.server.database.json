{
    "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "serverName": {
            "type": "string",
            "metadata": {
                "description": "Must be a unique sql server name: *****.database.windows.net"
            }
        },
        "location": {
            "type": "string",
            "defaultValue": "[resourceGroup().location]",
            "allowedValues": [
                "Australia Central",
                "Australia Central 2",
                "Australia East",
                "Australia SouthEast",
                "Brazil South",
                "Canada Central",
                "Canada East",
                "Central India",
                "Central US",
                "East Asia",
                "East US",
                "East US 2",
                "France Central",
                "France South",
                "Japan East",
                "Japan West",
                "Korea Central",
                "Korea South",
                "North Central US",
                "North Europe",
                "South Central US",
                "South India",
                "Southeast Asia",
                "UK South",
                "UK West",
                "West Central US",
                "West Europe",
                "West India",
                "West US",
                "West US 2"
            ],
            "metadata": {
                "description": "Location for the SQL Server."
            }
        },
        "administratorLogin": {
            "type": "string",
            "metadata": {
                "description": "The admin user of the SQL Server"
            }
        },
        "administratorPassword": {
            "type": "securestring",
            "metadata": {
                "description": "The password of the admin user of the SQL Server"
            }
        },
        "databaseName": {
            "type": "string",
            "metadata": {
                "description": "The name of the new database to create."
            }
        },
        "tier": {
            "type": "string",
            "defaultValue": "Basic",
            "allowedValues": [
                "Basic",
                "Standard",
                "Premium"
            ],
            "metadata": {
                "description": "The type of database to create."
            }
        },
        "sku": {
            "type": "string",
            "defaultValue": "Basic",
            "allowedValues": [
                "Basic",
                "S0",
                "S1",
                "S2",
                "S3",
                "S4",
                "S6",
                "S7",
                "S9",
                "S12",
                "P1",
                "P2",
                "P4",
                "P6",
                "P11",
                "P15"
            ],
            "metadata": {
                "description": "Describes the performance level for Edition"
            }
        },
        "maxSizeBytes": {
            "type": "string",
            "defaultValue": "2147483648",
            "metadata": {
                "description": "The maximum size, in bytes, for the database"
            }
        },
        "collation": {
            "type": "string",
            "defaultValue": "SQL_Latin1_General_CP1_CI_AS",
            "metadata": {
                "description": "The database collation for governing the proper use of characters."
            }
        }
    },
    "variables": {},
    "resources": [
        {
            "name": "[parameters('serverName')]",
            "type": "Microsoft.Sql/servers",
            "apiVersion": "2015-05-01-preview",
            "location": "[parameters('location')]",
            "tags": {},
            "identity": {
                "type": "SystemAssigned"
            },
            "properties": {
                "administratorLogin": "[parameters('administratorLogin')]",
                "administratorLoginPassword": "[parameters('administratorPassword')]"
            },
            "resources": [
                {
                    "type": "databases",
                    "sku": {
                        "name": "[parameters('sku')]",
                        "tier": "[parameters('tier')]"
                    },
                    "name": "[parameters('databaseName')]",
                    "apiVersion": "2017-10-01-preview",
                    "location": "[parameters('location')]",
                    "properties": {
                        "collation": "[parameters('collation')]",
                        "maxSizeBytes": "[parameters('maxSizeBytes')]",
                        "zoneRedundant": false
                    },
                    "dependsOn": [
                        "[concat('Microsoft.Sql/servers/', parameters('serverName'))]"
                    ],
                    "resources": [
                        {
                            "condition": "[not(equals(parameters('tier'), 'Basic'))]",
                            "name": "DefaultLongTermRetentionPolicy",
                            "type": "backupLongTermRetentionPolicies",
                            "dependsOn": [
                              "[concat('Microsoft.Sql/servers/', parameters('serverName'), '/', 'databases', '/', parameters('databaseName'))]"
                            ],
                            "apiVersion": "2017-03-01-preview",
                            "properties": {
                              "weeklyRetention": "P3W",
                              "monthlyRetention": "P2M",
                              "yearlyRetention": "P1Y",
                              "weekOfYear": 1
                            }
                          }
                    ]
                },
                {
                    "type": "firewallRules",
                    "apiVersion": "2015-05-01-preview",
                    "dependsOn": [
                        "[concat('Microsoft.Sql/servers/', parameters('serverName'))]"
                    ],
                    "location": "[parameters('location')]",
                    "name": "AllowAllWindowsAzureIps",
                    "properties": {
                        "endIpAddress": "0.0.0.0",
                        "startIpAddress": "0.0.0.0"
                    }
                }
            ]
        }
    ],
    "outputs": {
        "server": {
            "type": "object",
            "value": "[reference(parameters('serverName'), '2015-05-01-preview', 'Full')]"
        },
        "database": {
            "type": "object",
            "value": "[reference(parameters('databaseName'), '2017-10-01-preview', 'Full')]"
        }
    }
}