{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "project": {
      "type": "string"
    },
    "app": {
      "type": "string"
    },
    "environment": {
      "type": "string",
      "metadata": {
        "description": "Name of the environment.",
        "restrictions": "project+environment length should be max 20. Required by Azure storage naming conventions."
      },
      "allowedValues": [
        "prod",
        "dev",
        "release",
        "uat",
        "staging",
        "test",
        "qa",
        "local"
      ]
    },
    "size": {
      "type": "string",
      "defaultValue": "Small",
      "allowedValues": [
        "ExtraSmall",
        "Small",
        "Medium",
        "Large",
        "ExtraLarge"
      ]
    },
    "target": {
      "type": "string",
      "defaultValue": "x64",
      "allowedValues": [
        "x86",
        "x64"
      ]
    },
    "templateBaseUrl": {
      "type": "string",
      "defaultValue": "https://raw.githubusercontent.com/Lateral-Pathfinder/arm-templates/master/templates/",
      "metadata": {
        "description": "Location for the individual deployment templates. If it's a blob storage account, the templateSasToken must have a value."
      }
    },
    "templateSasToken": {
      "type": "string",
      "defaultValue": " ",
      "metadata": {
        "description": "Sas Token for Azure storage account. Used when the individual templates are linked from blob storage"
      }
    },
    "consolidateServerFarms": {
      "type": "string",
      "allowedValues": [
        "Yes",
        "No"
      ],
      "defaultValue": "No",
      "metadata": {
        "description": "If Yes, multiple environments will have one single serverfarm and resource group. Cuts down costs."
      }
    },
    "actionGroupId": {
      "type": "string",
      "metadata": {
        "description": "Actiongroup Id to set up alerts."
      }
    },
    "customDomain": {
      "type": "string",
      "metadata": {
        "description": "Custom domain for the project."
      }
    },
    "createDomains": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "decription": "Skip custom domains creation at first run, it needs the apps to exist."
      }
    },
    "keyVaultName": {
      "type": "string",
      "metadata": {
        "description": "KeyVault to link this application to."
      }
    },
    "instrumentationKey": {
      "type": "string",
      "metadata": {
        "description": "App Insights instrumentation key."
      }
    }
  },
  "variables": {
    "deploymentMode": "Incremental",
    "serverFarmName": "[if(equals(parameters('consolidateServerFarms'), 'Yes'), concat('prod-', parameters('project'), '-webserver'), concat(parameters('environment') ,'-', parameters('project'), '-webserver'))]",
    "serverFarmResourceGroupName": "[if(equals(parameters('consolidateServerFarms'), 'Yes'), concat('prod-', parameters('project')), concat(parameters('environment') ,'-', parameters('project')))]",
    "appName": "[concat(parameters('environment'), '-', parameters('app'), '-', parameters('project'))]",
    "hostName": "[if(equals(parameters('environment'),'prod'), concat(parameters('app'), '.', parameters('customDomain')), concat(parameters('environment'), '-', parameters('app'), '.', parameters('customDomain')))]"
  },
  "resources": [
    {
      "apiVersion": "2017-05-10",
      "name": "[concat(parameters('app'), 'environmentSize')]",
      "type": "Microsoft.Resources/deployments",
      "properties": {
        "mode": "[variables('deploymentMode')]",
        "templateLink": {
          "uri": "[concat(parameters('templateBaseUrl'), 'utils/Environment.Size.json', parameters('templateSasToken'))]"
        },
        "parameters": {
          "size": {
            "value": "[parameters('size')]"
          }
        }
      }
    },
    {
      "condition": "[or(equals(parameters('consolidateServerFarms'), 'No'), equals(parameters('environment'), 'prod'))]",
      "apiVersion": "2017-05-10",
      "name": "[concat('serverFarm', parameters('app'))]",
      "type": "Microsoft.Resources/deployments",
      "properties": {
        "mode": "[variables('deploymentMode')]",
        "templateLink": {
          "uri": "[concat(parameters('templateBaseUrl'), 'web/Microsoft.Web.serverfarms.json', parameters('templateSasToken'))]"
        },
        "parameters": {
          "name": {
            "value": "[variables('serverFarmName')]"
          },
          "sku": {
            "value": "[reference(concat(parameters('app'), 'environmentSize')).outputs.size.value.serverFarm.sku]"
          },
          "skuCode": {
            "value": "[reference(concat(parameters('app'), 'environmentSize')).outputs.size.value.serverFarm.skuCode]"
          },
          "autoscaleEnabled": {
            "value": "[reference(concat(parameters('app'), 'environmentSize')).outputs.size.value.serverFarm.autoscale.enabled]"
          },
          "defaultCapacity": {
            "value": "[reference(concat(parameters('app'), 'environmentSize')).outputs.size.value.serverFarm.autoscale.capacity.default]"
          },
          "minimumCapacity": {
            "value": "[reference(concat(parameters('app'), 'environmentSize')).outputs.size.value.serverFarm.autoscale.capacity.minimum]"
          },
          "maximumCapacity": {
            "value": "[reference(concat(parameters('app'), 'environmentSize')).outputs.size.value.serverFarm.autoscale.capacity.maximum]"
          }
        }
      },
      "dependsOn": [
        "[concat(parameters('app'), 'environmentSize')]"
      ]
    },
    {
      "apiVersion": "2017-05-10",
      "name": "[parameters('app')]",
      "type": "Microsoft.Resources/deployments",
      "properties": {
        "mode": "[variables('deploymentMode')]",
        "templateLink": {
          "uri": "[concat(parameters('templateBaseUrl'), 'web/Microsoft.Web.sites.', parameters('target'), '.json', parameters('templateSasToken'))]"
        },
        "parameters": {
          "name": {
            "value": "[variables('appName')]"
          },
          "hostingPlanName": {
            "value": "[variables('serverFarmName')]"
          },
          "serverFarmResourceGroup": {
            "value": "[variables('serverFarmResourceGroupName')]"
          },
          "appSettings": {
            "value": [
              {
                "name": "ASPNETCORE_ENVIRONMENT",
                "value": "[parameters('environment')]",
                "slotSetting": false
              },
              {
                "name": "APPINSIGHTS_INSTRUMENTATIONKEY",
                "value": "[parameters('instrumentationKey')]",
                "slotSetting": false
              },
              {
                "name": "LOG_EVENTLEVEL",
                "value": "Information",
                "slotSetting": false
              },
              {
                "name": "KeyVault--BaseUrl",
                "value": "[concat('https://', parameters('keyVaultName'), '.vault.azure.net/')]",
                "slotSetting": false
              },
              {
                "name": "APPINSIGHTS_PROFILERFEATURE_VERSION",
                "value": "1.0.0",
                "slotSetting": false
              },
              {
                "name": "APPINSIGHTS_SNAPSHOTFEATURE_VERSION",
                "value": "1.0.0",
                "slotSetting": false
              },
              {
                "name": "ApplicationInsightsAgent_EXTENSION_VERSION",
                "value": "~2",
                "slotSetting": false
              },
              {
                "name": "DiagnosticServices_EXTENSION_VERSION",
                "value": "~3",
                "slotSetting": false
              },
              {
                "name": "InstrumentationEngine_EXTENSION_VERSION",
                "value": "disabled",
                "slotSetting": false
              },
              {
                "name": "SnapshotDebugger_EXTENSION_VERSION",
                "value": "disabled",
                "slotSetting": false
              },
              {
                "name": "XDT_MicrosoftApplicationInsights_BaseExtensions",
                "value": "disabled",
                "slotSetting": false
              },
              {
                "name": "XDT_MicrosoftApplicationInsights_Mode",
                "value": "recommended",
                "slotSetting": false
              }
            ]
          }
        }
      },
      "dependsOn": [
        "[concat('serverFarm', parameters('app'))]",
        "[concat('insights', parameters('app'))]"
      ]
    },
    {
      "apiVersion": "2017-05-10",
      "name": "[concat('hostname-certificate-', parameters('app'))]",
      "type": "Microsoft.Resources/deployments",
      "condition": "[parameters('createDomains')]",
      "properties": {
        "mode": "[variables('deploymentMode')]",
        "templateLink": {
          "uri": "[concat(parameters('templateBaseUrl'), 'web/Microsoft.Web.hostName.certificate.json', parameters('templateSasToken'))]"
        },
        "parameters": {
          "app": {
            "value": "[variables('appName')]"
          },
          "hostingPlanName": {
            "value": "[variables('serverFarmName')]"
          },
          "hostName": {
            "value": "[variables('hostName')]"
          },
          "templateBaseUrl": {
            "value": "[parameters('templateBaseUrl')]"
          },
          "templateSasToken": {
            "value": "[parameters('templateSasToken')]"
          }
        }
      },
      "dependsOn": [
        "[parameters('app')]"
      ]
    },
    {
      "apiVersion": "2017-05-10",
      "name": "[concat('ssl-binding-', parameters('app'))]",
      "type": "Microsoft.Resources/deployments",
      "condition": "[parameters('createDomains')]",
      "properties": {
        "mode": "[variables('deploymentMode')]",
        "templateLink": {
          "uri": "[concat(parameters('templateBaseUrl'), 'web/Microsoft.Web.sslBinding.json', parameters('templateSasToken'))]"
        },
        "parameters": {
          "app": {
            "value": "[variables('appName')]"
          },
          "hostName": {
            "value": "[variables('hostName')]"
          },
          "thumbprint": {
            "value": "[reference(concat('hostname-certificate-', parameters('app'))).outputs.thumbprint.value]"
          }
        }
      },
      "dependsOn": [
        "[concat('hostname-certificate-', parameters('app'))]"
      ]
    },
    {
      "apiVersion": "2017-05-10",
      "name": "[concat('KVAccess', parameters('app'), 'AzureAppService')]",
      "type": "Microsoft.Resources/deployments",
      "properties": {
        "mode": "[variables('deploymentMode')]",
        "templateLink": {
          "uri": "[concat(parameters('templateBaseUrl'), 'keyvault/Microsoft.KeyVault.accessPolicies.json', parameters('templateSasToken'))]"
        },
        "parameters": {
          "keyVaultName": {
            "value": "[parameters('keyVaultName')]"
          },
          "objectId": {
            "value": "abfa0a7c-a6b6-4736-8310-5855508787cd"
          },
          "secretsPermissions": {
            "value": [
              "Get",
              "List",
              "Set",
              "Delete",
              "Recover",
              "Backup",
              "Restore"
            ]
          }
        }
      }
    },
    {
      "apiVersion": "2017-05-10",
      "name": "[concat('KVAccess', parameters('app'))]",
      "type": "Microsoft.Resources/deployments",
      "properties": {
        "mode": "[variables('deploymentMode')]",
        "templateLink": {
          "uri": "[concat(parameters('templateBaseUrl'), 'keyvault/Microsoft.KeyVault.accessPolicies.json', parameters('templateSasToken'))]"
        },
        "parameters": {
          "keyVaultName": {
            "value": "[parameters('keyVaultName')]"
          },
          "objectId": {
            "value": "[reference(parameters('app')).outputs.site.value.identity.principalId]"
          },
          "secretsPermissions": {
            "value": [
              "list",
              "get"
            ]
          }
        }
      },
      "dependsOn": [
        "[parameters('app')]"
      ]
    },
    {
      "condition": "[or(equals(parameters('consolidateServerFarms'), 'No'), equals(parameters('environment'), 'prod'))]",
      "apiVersion": "2017-05-10",
      "name": "[concat('WebServerHighCPUAlert', parameters('app'))]",
      "type": "Microsoft.Resources/deployments",
      "properties": {
        "mode": "[variables('deploymentMode')]",
        "templateLink": {
          "uri": "[concat(parameters('templateBaseUrl'), 'insights/Microsoft.Insights.metricAlerts.json', parameters('templateSasToken'))]"
        },
        "parameters": {
          "alertName": {
            "value": "HighCPU"
          },
          "alertDescription": {
            "value": "Web Server CPU usage over 80% for the last 5 minutes."
          },
          "resourceId": {
            "value": "[concat(subscription().id,'/resourcegroups/', variables('serverFarmResourceGroupName'), '/providers/Microsoft.Web/serverfarms/', variables('serverFarmName'))]"
          },
          "metricName": {
            "value": "CpuPercentage"
          },
          "threshold": {
            "value": "80"
          },
          "windowSize": {
            "value": "PT5M"
          },
          "actionGroupId": {
            "value": "[parameters('actionGroupId')]"
          }
        }
      },
      "dependsOn": [
        "[concat('serverFarm', parameters('app'))]"
      ]
    },
    {
      "condition": "[or(equals(parameters('consolidateServerFarms'), 'No'), equals(parameters('environment'), 'prod'))]",
      "apiVersion": "2017-05-10",
      "name": "[concat('WebServerMemoryPercentageAlert', parameters('app'))]",
      "type": "Microsoft.Resources/deployments",
      "properties": {
        "mode": "[variables('deploymentMode')]",
        "templateLink": {
          "uri": "[concat(parameters('templateBaseUrl'), 'insights/Microsoft.Insights.metricAlerts.json', parameters('templateSasToken'))]"
        },
        "parameters": {
          "alertName": {
            "value": "MemoryPercentage"
          },
          "alertDescription": {
            "value": "Web Server memory percentage over 80% for the last 5 minutes."
          },
          "resourceId": {
            "value": "[concat(subscription().id,'/resourcegroups/', variables('serverFarmResourceGroupName'), '/providers/Microsoft.Web/serverfarms/', variables('serverFarmName'))]"
          },
          "metricName": {
            "value": "MemoryPercentage"
          },
          "threshold": {
            "value": "80"
          },
          "windowSize": {
            "value": "PT5M"
          },
          "actionGroupId": {
            "value": "[parameters('actionGroupId')]"
          }
        }
      },
      "dependsOn": [
        "[concat('serverFarm', parameters('app'))]"
      ]
    },
    {
      "apiVersion": "2017-05-10",
      "name": "[concat('HttpServerErrorsAlert', parameters('app'))]",
      "type": "Microsoft.Resources/deployments",
      "properties": {
        "mode": "[variables('deploymentMode')]",
        "templateLink": {
          "uri": "[concat(parameters('templateBaseUrl'), 'insights/Microsoft.Insights.metricAlerts.json', parameters('templateSasToken'))]"
        },
        "parameters": {
          "alertName": {
            "value": "[concat('HttpServerErrors', parameters('app'))]"
          },
          "alertDescription": {
            "value": "More than 10 server errors in the last 5 minutes."
          },
          "resourceId": {
            "value": "[concat(subscription().id,'/resourcegroups/', resourceGroup().name, '/providers/Microsoft.Web/sites/', variables('appName'))]"
          },
          "metricName": {
            "value": "Http5xx"
          },
          "threshold": {
            "value": "10"
          },
          "timeAggregation": {
            "value": "Total"
          },
          "windowSize": {
            "value": "PT5M"
          },
          "actionGroupId": {
            "value": "[parameters('actionGroupId')]"
          }
        }
      },
      "dependsOn": [
        "[parameters('app')]"
      ]
    },
    {
      "apiVersion": "2017-05-10",
      "name": "[concat('ResponseTimeAlert', parameters('app'))]",
      "type": "Microsoft.Resources/deployments",
      "properties": {
        "mode": "[variables('deploymentMode')]",
        "templateLink": {
          "uri": "[concat(parameters('templateBaseUrl'), 'insights/Microsoft.Insights.metricAlerts.json', parameters('templateSasToken'))]"
        },
        "parameters": {
          "alertName": {
            "value": "[concat('AverageResponseTime', parameters('app'))]"
          },
          "alertDescription": {
            "value": "Average response time over 5 seconds in the last 5 minutes."
          },
          "resourceId": {
            "value": "[concat(subscription().id,'/resourcegroups/', resourceGroup().name, '/providers/Microsoft.Web/sites/', variables('appName'))]"
          },
          "metricName": {
            "value": "AverageResponseTime"
          },
          "threshold": {
            "value": "5"
          },
          "windowSize": {
            "value": "PT5M"
          },
          "actionGroupId": {
            "value": "[parameters('actionGroupId')]"
          }
        }
      },
      "dependsOn": [
        "[parameters('app')]"
      ]
    },
    {
      "apiVersion": "2017-05-10",
      "name": "[concat('Ping', parameters('app'))]",
      "type": "Microsoft.Resources/deployments",
      "properties": {
        "mode": "[variables('deploymentMode')]",
        "templateLink": {
          "uri": "[concat(parameters('templateBaseUrl'), 'insights/Microsoft.Insights.webtest.json', parameters('templateSasToken'))]"
        },
        "parameters": {
          "name": {
            "value": "[concat(variables('appName'), '-ping')]"
          },
          "description": {
            "value": "Ping app to ensure it's alive."
          },
          "insightsName": {
            "value": "[variables('appName')]"
          },
          "testUrl": {
            "value": "[concat('https://', variables('hostName'))]"
          }
        }
      },
      "dependsOn": [
        "[concat('insights', parameters('app'))]",
        "[parameters('app')]"
      ]
    }
  ],
  "outputs": {
    "site": {
      "type": "object",
      "value": "[reference(parameters('app')).outputs.site.value]"
    }
  },
  "functions": [
  ]
}